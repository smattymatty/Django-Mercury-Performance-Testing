# Issue #5: Add HTML Report Export

**Label:** `enhancement`, `reporting`
**Milestone:** v0.1.1
**Estimated Effort:** 40 minutes

## Problem

Terminal reports are great for dev, but hard to share with team/stakeholders. Need visual, shareable reports.

## Proposed Solution

Add `result.to_html()` method that generates standalone HTML file with charts and interactive elements.

```python
with monitor() as result:
    response = self.client.get('/api/users/')

# Export to HTML
result.to_html('performance_report.html')
```

**Example output:**

![HTML Report Mockup](https://via.placeholder.com/800x600?text=Mercury+Performance+Report)

Features:
- **Summary card:** Pass/fail status, key metrics
- **Charts:** Response time graph, query count bar chart
- **N+1 details:** Expandable sections with SQL samples
- **Timeline:** When test was run, duration
- **Interactive:** Click SQL to copy, expand/collapse sections
- **Standalone:** Single HTML file (no external dependencies)

## Acceptance Criteria

- [ ] `MonitorResult.to_html(filename)` method
- [ ] Generates single standalone HTML file
- [ ] Includes inline CSS (no external stylesheets)
- [ ] Color-coded pass/fail indicators
- [ ] Charts for metrics (using Chart.js CDN or inline SVG)
- [ ] Expandable SQL query samples
- [ ] Responsive design (works on mobile)
- [ ] Optional: Generate from summary of multiple tests

## Implementation Notes

**File:** `django_mercury/export.py` (new)

```python
from typing import List
from .monitor import MonitorResult

HTML_TEMPLATE = """
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mercury Performance Report - {test_name}</title>
    <style>
        /* Inline CSS for standalone file */
        body {{
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }}
        .card {{
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }}
        .pass {{ color: #22c55e; }}
        .fail {{ color: #ef4444; }}
        .metric {{
            display: inline-block;
            margin-right: 30px;
        }}
        .sql-sample {{
            background: #f8f8f8;
            padding: 10px;
            border-left: 3px solid #3b82f6;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
        }}
        details {{
            cursor: pointer;
            margin: 10px 0;
        }}
        summary {{
            font-weight: bold;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 4px;
        }}
    </style>
</head>
<body>
    <div class="card">
        <h1>Mercury Performance Report</h1>
        <p><strong>Test:</strong> {test_name}</p>
        <p><strong>Location:</strong> <code>{test_location}</code></p>
        <p><strong>Status:</strong> <span class="{status_class}">{status}</span></p>
    </div>

    <div class="card">
        <h2>Metrics</h2>
        <div class="metric">
            <strong>Response Time:</strong>
            <span class="{time_class}">{response_time}ms</span>
            <small>(threshold: {time_threshold}ms)</small>
        </div>
        <div class="metric">
            <strong>Query Count:</strong>
            <span class="{query_class}">{query_count}</span>
            <small>(threshold: {query_threshold})</small>
        </div>
    </div>

    {n_plus_one_section}

    {warnings_section}

    {failures_section}

    <div class="card">
        <p style="color: #666; font-size: 14px;">
            Generated by Django Mercury Performance Testing v{version}
        </p>
    </div>
</body>
</html>
"""

def export_html(result: MonitorResult, filename: str):
    """Export MonitorResult to standalone HTML file."""

    # Determine status
    status = "PASSED" if not result.failures else "FAILED"
    status_class = "pass" if not result.failures else "fail"

    # Color-code metrics
    time_class = "pass" if result.response_time_ms <= result.thresholds['response_time_ms'] else "fail"
    query_class = "pass" if result.query_count <= result.thresholds['query_count'] else "fail"

    # Format N+1 section
    n_plus_one_section = ""
    if result.n_plus_one_patterns:
        n_plus_one_section = '<div class="card"><h2>N+1 Patterns Detected</h2>'
        for pattern in result.n_plus_one_patterns:
            n_plus_one_section += f"""
            <details>
                <summary>{pattern.count}x {pattern.normalized_query[:80]}</summary>
                <div class="sql-sample">
                    {'<br>'.join(pattern.sample_queries[:3])}
                </div>
            </details>
            """
        n_plus_one_section += '</div>'

    # Generate HTML
    html = HTML_TEMPLATE.format(
        test_name=result.test_name or "Unknown",
        test_location=result.test_location or "Unknown",
        status=status,
        status_class=status_class,
        response_time=f"{result.response_time_ms:.2f}",
        time_threshold=result.thresholds['response_time_ms'],
        time_class=time_class,
        query_count=result.query_count,
        query_threshold=result.thresholds['query_count'],
        query_class=query_class,
        n_plus_one_section=n_plus_one_section,
        warnings_section=_format_warnings_html(result.warnings),
        failures_section=_format_failures_html(result.failures),
        version="0.1.1",  # Get from package metadata
    )

    # Write to file
    with open(filename, 'w') as f:
        f.write(html)

# Add to MonitorResult class:
def to_html(self, filename: str):
    """Export this result to HTML report."""
    from .export import export_html
    export_html(self, filename)
```

## Enhancement Ideas (Future)

1. **Charts:** Add Chart.js for visual metrics (response time over time, query distribution)
2. **Comparison:** Compare multiple test runs side-by-side
3. **Dark mode:** Respect `prefers-color-scheme`
4. **Interactive SQL:** Syntax highlighting with Prism.js
5. **Export formats:** Also support PDF, Markdown, JSON

## Design Considerations

**Standalone vs External Assets:**
- Inline CSS/JS = larger file, but truly standalone
- CDN assets = smaller file, but requires internet
- **Decision:** Start with inline, add CDN option later

**Accessibility:**
- Use semantic HTML
- Proper color contrast
- Keyboard navigation for interactive elements

**Performance:**
- For large test suites (100+ tests), consider pagination
- Lazy-load SQL samples (collapsed by default)

## Examples of Similar Tools

- pytest-html: https://pytest-html.readthedocs.io/
- coverage.py HTML reports
- locust.io reports

## Testing

- [ ] Test with single result
- [ ] Test with N+1 patterns
- [ ] Test with failures
- [ ] Test with warnings only
- [ ] Validate HTML with W3C validator
- [ ] Test on mobile viewport
